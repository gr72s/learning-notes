- [核心类继承关系](#核心类继承关系)
- [核心类主要功能](#核心类主要功能)
  - [`bean`注册](#bean注册)
    - [`Interface`](#interface)
    - [`Class`](#class)
  - [`bean`工厂](#bean工厂)
    - [`Interface`](#interface-1)
    - [`Class`](#class-1)
  - [加载`bean`资源](#加载bean资源)
# 核心类继承关系
![](images/DefaultListableBeanFactory.png)
1. 核心类方法命名规则简述
   * 增: `add registry put`
   * 删: `remove delete pop`
   * 查: `get`
   * 判: `is contain`
   * 计: `count`

# 核心类主要功能
## `bean`注册
### `Interface`
1. `AliasRegistry`
   * 定义对`alias`的增删查判操作
   * `bean`名与`alias`对应,同样为`String`
2. `BeanDefinitionDegistry`
   * 定义对`BeanDefinition`的增删查判计操作, `bean`名与`BeanDefinition`实例对应
   * 是`spring`中封装`BeanDefinition`的唯一接口, 在自定义扩展`BeanDefinition`时应实现此接口
4. `SingletonBeanRegistry`: `bean`的增删查判计操作
### `Class`
1. `SimpleAliasRegistry`
   * `extends AliasRegistry`
   * 使用`Map<alias, name> $=new ConcurrentHashMap<>(16)`存储
   * 提供嵌套`alias`功能
5. `DefaultSingletonBeanRegistry`
   * `extends SimpleAliasRegistry implements SingletonBeanRegistry`
   * 不包含`Object(bean)`创建过程, 由`DefaultListableBeanFactory(AbstractAutowireCapableBeanFactory)`创建
   * 存储不同状态下的`bean`实例
     * 创建完成的`bean`的集合: `Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256)`
     * 创建完成的`bean`的名称集合: `Set<String> registeredSingletons = new LinkedHashSet<>(256);`
     * 创建未完成`bean`的`ObjectFactory`: `Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>(16);`
     * 未完成初始化: `Map<String, Object> earlySingletonObjects = new HashMap<>(16);`
     * 未完成初始化的名称集合: `Set<String> singletonsCurrentlyInCreation =
			Collections.newSetFromMap(new ConcurrentHashMap<>(16));`
     * 被依赖的集合: 
       * `Map<String, Set<String>> dependentBeanMap = new ConcurrentHashMap<>(64)`
       * `key(String)`: `bean`
       * `value(Set<String>>)`: 所有依赖`key`的`bean`
     * 依赖的集合:
       * `Map<String, Set<String>> dependenciesForBeanMap = new ConcurrentHashMap<>(64)`
       * `key(String)`: `bean`
       * `value(Set<String>>)`: 所有`key`依赖的`bean`
   * 注册单例`bean`时, 相同的`bean`只允许存在一个, 否则在注册时会抛出`IllegalStateException`异常
   * 注册`bean`之间的依赖时会在`dependentBeanMap`、`dependenciesForBeanMap`集合中存储`bean`之间的关系
   * 通过`dependentBeanMap`判断两个`bean`之间是否依赖
6. `FactoryBeanRegistrySupport`
   * `extends DefaultSingletonBeanRegistry`
   * 定义了对`FactoryBean`的操作
## `bean`工厂
### `Interface` 
1. `BeanFactory`
   * 是容器的注册中心, 集中了`bean`统一配置入口
   * `bean`的唯一标识是一个`String`
   * `BeanFactory`要么返回原型, 要么返回单例
   * 定义了查判`bean`、`bean type`的一系列方法
8. `HierarchicalBeanFactory`
   * `extends BeanFactory`
   * 返回父`bean factory`的方法
   * 判断当前`bean factory`是否存在`bean`
9. `ConfigurableBeanFactory`
    * `extends HierarchicalBeanFactory, SingletonBeanRegistry`
    * 用于自定义配置`BeanFactory`, 例如
      * 配置`bean`的`scope`
      * 配置`ParentBeanFactory`、`ClassLoader`及`TempClassLoader`
      * 配置`spel`解析类, 解析
      * 配置`bean`属性转换解析类
      * 配置属性的类型转换器
      * 配置字符串解析器: 例如`${}`, 不确定与`spel`解析类的区别
      * 配置`BeanPostProcessor`
      * 配置`alias`解析类
      * 返回`merge`后的`BeanDefinition`
      * 判断`bean`的创建状态
      * 返回`bean`的依赖数组
      * 销毁`bean`
10. `ListableBeanFactory`
    * `extends BeanFactory`
    * 可以枚举出`bean`的名称, 而不是像`getBean(String name)`一样需要传入`bean`的名称, 例如
      * 根据名称返回名称数组或`map`
      * 根据类型返回名称数组`map`
      * 根据注解返回名称数组或`map`
11. `AutowireCapableBeanFactory`
    * 实例化一个`Bean`并自动装配, 被装配的属性对象由`spring`管理
    * 实例化的`Bean`可以不被`spring`管理, 可以与其它框架集成`spring`无法控制的`Bean`
12. `ConfigurableListableBeanFactory`
### `Class`
1. `AbstractBeanFactory`
   * `*BeanFactory`、`*Registry`的基本实现, 不包含创建的方法
   * `doGetBean`创建`bean`, `alreadyCreated`存放将要被创建的`bean`
2. `AbstractAutowireCapableBeanFactory`
   * `doCreateBean`
     * `createBeanInstance()`指定不同的策略实例化`bean`
       * `obtainFromSupplier()`: 从指定的`Supplier`接口中获得实例
       * `instantiateUsingFactoryMethod()`: 从指定的工厂方法中获得实例
       * `autowireConstructor()`: 通过自动装配构造函数参数获得实例
       * `instantiateBean()`: 默认构造函数实例化, 生成`BeanWrapper`. 如果是方法注入则必须使用`Cglib`生成子类(`CglibSubclassingInstantiationStrategy`)
     * `applyMergedBeanDefinitionPostProcessors()`: 调用`BeanPostProcessor`处理
     * `initializeBean`: 调用`bean`的回调, 主要为`InitializingBean`、`Aware`
3. `DefaultListableBeanFactory`
   * 当`bean`是`abstract`或`lazy-init`时, 跳过实例化方法`AbstractBeanFactory#doGetBean()`
4. `XmlBeanFactory`

## 加载`bean`资源
![](images/BeanDefinitionReader.png)
1. `BeanDefinitionReader`
   * 定义了加载资源的接口
   * 通过`BeanDefinitionRegistry getRegistry();`与`BeanDefinitionRegistry`关联(默认的实现为`DefaultListableBeanFactory`)
   * 通过`ResourceLoader getResourceLoader();`与`ResourceLoader`关联
2. `AbstractBeanDefinitionReader`
   * 主要用于转换传入的资源路径, 转换为`Resource`类并分别调用`loadBeanDefinitions(Resource resource)`
   * `int loadBeanDefinitions(Resource resource)`由子类实现
3. `PropertiesBeanDefinitionReader`
   * 解析`properties`, 例如`x1.(class)=java.lang.Integer`
   * `registerBeanDefinition()`方法解析`properties`中定义的属性, 用于创建`AbstractBeanDefinition`
   * 创建完毕后调用`DefaultListableBeanFactory#registerBeanDefinition()`放入`BeanDefinition`的`Map`集合中